fixtures:
    - ConfigFixture

tests:
    - name: create archive policy
      desc: for later use
      url: /v1/archive_policy
      method: POST
      request_headers:
          content-type: application/json
          x-roles: admin
      data:
          name: medium
          definition:
              - granularity: 1 second
      status: 201

    - name: get metric empty
      url: /v1/metric
      status: 200
      response_headers:
           location: /$SCHEME://$NETLOC/v1/metric
           content-type: application/json; charset=UTF-8
      response_strings:
          - "[]"

    - name: create metric bad archive policy
      url: /v1/metric
      method: POST
      request_headers:
          content-type: application/json
      data:
          archive_policy_name: bad-cookie
      status: 400

    - name: create metric bad content-type
      url: /v1/metric
      method: POST
      request_headers:
          content-type: plain/text
      data:
          archive_policy_name: medium
      status: 415

    - name: create valid metric
      url: /v1/metric
      method: POST
      request_headers:
          content-type: application/json
      data:
        archive_policy_name: medium
      status: 201
      response_headers:
           location: /$SCHEME://$NETLOC/v1/metric
           content-type: application/json; charset=UTF-8
      response_json_paths:
          archive_policy_name: medium

    - name: get valid metric id
      url: /v1/metric/$RESPONSE['$.id']
      status: 200
      response_headers:
           location: /$SCHEME://$NETLOC/v1/metric/$RESPONSE['$.id']
           content-type: application/json; charset=UTF-8
      response_json_paths:
          archive_policy_name: medium

    - name: get valid metric id with details
      url: /v1/metric/$RESPONSE['$.id']?details=true
      status: 200
      response_headers:
           location: /$SCHEME://$NETLOC/v1/metric/$RESPONSE['$.id']
           content-type: application/json; charset=UTF-8
      response_json_paths:
          $.archive_policy.name: medium
          $.archive_policy.definition[0].granularity: "0:00:01"

    - name: get valid metric id with details via headers
      url: /v1/metric/$RESPONSE['$.id']
      request_headers:
          accept: application/json; details=true
      status: 200
      response_headers:
           location: /$SCHEME://$NETLOC/v1/metric/$RESPONSE['$.id']
           content-type: application/json; charset=UTF-8
      response_json_paths:
          $.archive_policy.name: medium
          $.archive_policy.definition[0].granularity: "0:00:01"

    - name: push measurements to metric
      url: /v1/metric/$RESPONSE['$.id']/measures
      request_headers:
           content-type: application/json
      method: post
      data:
          - timestamp: "2015-03-06T14:33:57"
            value: 43.1
          - timestamp: "2015-03-06T14:34:12"
            value: 12
      response_headers:
           location: /$SCHEME://$NETLOC/v1/metric/$RESPONSE['$.id']/measures
           content-type: application/json; charset=UTF-8
      status: 204

    - name: get measurements from metric
      url: $LOCATION
      xfail: true
      status: 200
      response_headers:
           location: /$SCHEME://$NETLOC/v1/metric/$RESPONSE['$.id']/measures
           content-type: application/json; charset=UTF-8
      response_json_paths:
          $[0].value: 43.1
          $[1].value: 12

    - name: get bad metric id
      desc: https://bugs.launchpad.net/gnocchi/+bug/1429949
      url: /v1/metric/bad-cookie
      xfail: true
      status: 404

    - name: get metric list
      url: /v1/metric
      status: 200
      response_headers:
           location: /$SCHEME://$NETLOC/v1/metric
           content-type: application/json; charset=UTF-8
      response_json_paths:
          $[0].archive_policy_name: medium
